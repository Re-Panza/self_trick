<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>LK Brain 337 - Self Trickle</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');

    :root {
      --bg: #000000;
      --card: #121212;
      --text: #e0e0e0;
      --gold: #ffc107;
      --green: #00e676;
      --red: #ff5252;
      --blue: #448aff;
      --border: #333;
      --selected-bg: #1a1a1a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Roboto Condensed', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      padding-bottom: 60px;
    }

    .container { max-width: 100%; margin: 0 auto; }

    /* CONTROLLI */
    .controls {
      background: var(--card); padding: 12px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
    .col { flex: 1; }
    
    label { font-size: 10px; color: #888; text-transform: uppercase; display: block; margin-bottom: 3px; letter-spacing: 0.5px; }
    
    input, select {
      width: 100%; background: #080808; color: #fff; border: 1px solid #444; 
      border-radius: 4px; padding: 10px; font-size: 15px; outline: none; font-weight: bold;
    }
    input:focus { border-color: var(--gold); }

    .btn {
      width: 100%; padding: 12px; background: var(--gold); color: #000;
      font-weight: bold; border: none; border-radius: 4px; 
      text-transform: uppercase; font-size: 14px; margin-top: 5px; cursor: pointer;
    }

    /* HEADER RISULTATI */
    .res-header-info {
      background: #1a1a1a; padding: 10px; border-bottom: 1px solid #333;
      text-align: center; font-size: 13px; color: #ccc;
    }
    .res-header-info a { color: var(--gold); text-decoration: none; font-weight: bold; }

    /* LISTA RISULTATI */
    .res-row {
      display: grid; 
      grid-template-columns: 50px 1fr 90px; 
      gap: 10px;
      align-items: center; padding: 10px; border-bottom: 1px solid #222; background: var(--bg);
      transition: background 0.2s;
    }
    .res-row:nth-child(even) { background: #0b0b0b; }
    
    /* STILE SELEZIONATO */
    .res-row.selected {
      background: var(--selected-bg) !important;
      border-left: 3px solid var(--gold);
    }
    
    .res-row.covered { opacity: 0.3; filter: grayscale(100%); }

    /* COLONNE */
    .col-time { text-align: center; border-right: 1px solid #222; padding-right: 5px; }
    .t-label { font-size: 9px; color: #888; text-transform: uppercase; }
    .t-val { font-size: 16px; color: #fff; font-weight: bold; line-height: 1.2; }

    .col-info { display: flex; flex-direction: column; justify-content: center; }
    .info-status { font-size: 13px; font-weight: bold; margin-bottom: 2px; }
    .info-sub { font-size: 11px; color: #888; line-height: 1.3; }
    .info-sub span { color: #ccc; }
    .bounce-win { color: var(--gold); font-weight: bold; }

    .col-action { display: flex; flex-direction: column; gap: 5px; }

    /* BOTTONI */
    .lnk-btn {
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 32px; background: rgba(68, 138, 255, 0.15); 
      border: 1px solid var(--blue); color: var(--blue); text-decoration: none; 
      font-size: 12px; font-weight: bold; border-radius: 4px; text-transform: uppercase;
      cursor: pointer;
    }
    .lnk-btn:active { background: var(--blue); color: white; }

    .chk-cover {
      width: 100%; height: 24px; display: flex; align-items: center; justify-content: center;
      background: #181818; border: 1px solid #333; border-radius: 4px; cursor: pointer; color: #666; font-size: 10px; text-transform: uppercase;
    }
    .chk-cover.active { background: #222; color: var(--green); border-color: var(--green); }

    /* MESSAGGIO FINE */
    .end-msg {
      padding: 20px; text-align: center; color: var(--red); font-weight: bold; 
      font-size: 13px; text-transform: uppercase; border-top: 1px solid #333;
    }

    /* STATUS COLORS */
    .st-wait { color: #aaa; }
    .st-now { color: var(--green); animation: pulse 1s infinite; }
    .st-err { color: var(--red); font-size: 11px; }

    @keyframes pulse { 50% { opacity: 0.6; } }
    .hidden { display: none !important; }
    .status-bar { font-size: 11px; text-align: center; color: #666; margin-bottom: 5px; min-height: 15px; }
  </style>
</head>

<body>

  <div id="inputArea" class="controls">
    <div class="row">
      <div class="col">
        <label>Inserisci castello attaccato</label>
        <input type="text" id="inCoord" placeholder="l+k://coordinates?x,y&337" oninput="checkDB()">
      </div>
    </div>
    <div id="dbStatus" class="status-bar" style="display:none"></div>

    <div class="row">
      <div class="col"><label>Data Impatto</label><input type="date" id="inDate"></div>
      <div class="col"><label>Ora Impatto</label><input type="time" id="inTime" step="60"></div>
    </div>

    <div class="row">
      <div class="col" style="flex:2"><label>Truppa</label><select id="selTroop"></select></div>
      <div class="col"><label>Plotone</label>
        <select id="selBatch">
          <option value="51" selected>51</option><option value="55">55</option>
          <option value="60">60</option><option value="76">76</option>
        </select>
      </div>
    </div>

    <div class="row" style="justify-content:space-between; padding:5px 0;">
      <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#fff; cursor:pointer">
        <input type="checkbox" id="chkMap" style="width:18px; height:18px"> Bonus Mappa (+5%)
      </label>
      <div style="display:flex; align-items:center; gap:5px">
        <label style="margin:0">Truppe Totali:</label>
        <input type="number" id="inGarrison" style="width:70px; text-align:center" placeholder="Es. 1000">
      </div>
    </div>

    <button class="btn" onclick="startCalc()">CALCOLA</button>
  </div>

  <div id="resArea" class="hidden">
    
    <div id="resHeaderInfo" class="res-header-info"></div>

    <div style="background:#151515; padding:8px; border-bottom:1px solid #333; display:flex; gap:10px; position:sticky; top:0; z-index:100">
      <button onclick="reset()" style="background:#333; color:#fff; border:none; padding:0 12px; font-weight:bold; border-radius:4px; font-size:16px">‚Üê</button>
      <select id="selBattleTroop" onchange="changeTroopLive()" style="background:#000; color:#fff; border:1px solid #444"></select>
    </div>
    
    <div id="resList" style="padding-bottom:20px"></div>
  </div>

  <script>
    // --- DATI ---
    const T_BASE = { "Lanciere":700, "Balestriere":600, "Cav. Pesante":300, "Spadaccino":800, "Arciere":500, "Cav. Leggero":400, "Carro":1000, "Torre":480, "Catapulta":420 };
    const T_BONUS = { "Lanciere":665, "Balestriere":570, "Cav. Pesante":285, "Spadaccino":760, "Arciere":475, "Cav. Leggero":380, "Carro":950, "Torre":456, "Catapulta":399 };

    let DB = [], myCastle = null, worldId = null;
    let rows = [], ticker = null;
    let selectedRowIndex = -1; 

    // --- INIT ---
    window.onload = () => {
      let html = "";
      for(let k in T_BASE) html += `<option value="${k}">${k}</option>`;
      document.getElementById('selTroop').innerHTML = html;
      document.getElementById('selBattleTroop').innerHTML = html;
      
      // Campi INPUT VUOTI all'inizio
      document.getElementById('inDate').value = "";
      document.getElementById('inTime').value = "";
      document.getElementById('inGarrison').value = "";
      document.getElementById('inCoord').value = "";
    };

    // --- DB LOAD ---
    function checkDB() {
      let val = document.getElementById('inCoord').value;
      let m = val.match(/coordinates\?(\d+),(\d+)&(\d+)/);
      let st = document.getElementById('dbStatus');
      
      if(m) {
        let w = m[3];
        if(w !== worldId) {
          worldId = w;
          // st.style.display = 'block'; // User ha chiesto di togliere dicitura
          // st.innerHTML = `<span style="color:var(--gold)">Scarico DB...</span>`;
          fetch(`https://raw.githubusercontent.com/Re-Panza/lk_database/refs/heads/main/database_mondo_${w}.json`)
            .then(r => r.json())
            .then(d => {
              DB = [];
              const flat = (n) => { 
                if(Array.isArray(n)) n.forEach(flat); 
                else if(n && n.x) {
                  n.p = n.p || n.pid || n.playerid || 0;
                  n.pt = n.pt || n.points || 0;
                  DB.push(n); 
                }
                else if(typeof n==='object') Object.values(n).forEach(flat); 
              };
              flat(d);
              // st.innerHTML = "";
            })
            .catch(() => {});
        }
      }
    }

    // --- MAIN CALC ---
    function startCalc() {
      if(!DB.length) return alert("Attendi il caricamento del DB (inserisci link valido)!");
      
      let val = document.getElementById('inCoord').value;
      let m = val.match(/coordinates\?(\d+),(\d+)&(\d+)/);
      if(!m) return alert("Link castello non valido");
      
      myCastle = { x: parseInt(m[1]), y: parseInt(m[2]) };
      
      // VALIDAZIONI
      let dVal = document.getElementById('inDate').value;
      let tVal = document.getElementById('inTime').value;
      
      if(!dVal || !tVal) return alert("Inserisci Data e Ora!");
      
      let startT = new Date(dVal + "T" + tVal);
      if(startT < new Date()) return alert("Non possiamo tornare nel passato! üï∞Ô∏è");
      
      let garrison = parseInt(document.getElementById('inGarrison').value);
      if(!garrison) return alert("Inserisci le Truppe Totali!");
      if(garrison > 4066) return alert("Non ci possono essere cos√¨ tante truppe! (Max 4066)");
      
      let batch = parseInt(document.getElementById('selBatch').value);
      
      // SETUP UI
      document.getElementById('selBattleTroop').value = document.getElementById('selTroop').value;
      document.getElementById('inputArea').classList.add('hidden');
      document.getElementById('resArea').classList.remove('hidden');
      
      // Header Castello Attaccato
      let dateStr = `${startT.getDate()}/${startT.getMonth()+1}`;
      let timeStr = `${pad(startT.getHours())}:${pad(startT.getMinutes())}`;
      document.getElementById('resHeaderInfo').innerHTML = `
        Target: <a href="${val}">(${myCastle.x},${myCastle.y})</a> &nbsp;|&nbsp; 
        Impatto: <span style="color:#fff">${dateStr} ${timeStr}</span>
      `;
      
      // LOGICA GENERAZIONE
      rows = [];
      selectedRowIndex = -1; 
      
      // Riserva 110 per il castello
      let available = garrison - 110;
      if(available < 0) available = 0;
      
      // Riga 0: Guarnigione (Impatto)
      rows.push({ t: new Date(startT), type: 'garrison' });
      
      let step = 1;
      
      // Genera finch√® ci sono truppe o limite 120 turni
      while(available >= batch && step < 120) {
        let combatT = new Date(startT.getTime() + (step * 600000)); 
        rows.push({ t: combatT, type: 'wave', target: null, covered: false });
        available -= batch;
        step++;
      }
      
      reCalcAll();
      if(ticker) clearInterval(ticker);
      ticker = setInterval(loop, 1000);
      renderList();
    }

    function reCalcAll() {
      let troop = document.getElementById('selBattleTroop').value;
      let bonus = document.getElementById('chkMap').checked;
      let speed = bonus ? T_BONUS[troop] : T_BASE[troop];
      
      rows.forEach(r => {
        if(r.type === 'wave' && !r.covered) {
          r.target = findTarget(r.t, speed);
        }
      });
    }

    function changeTroopLive() {
      reCalcAll();
      renderList();
    }

    // --- ALGORITMO DI RICERCA ---
    function findTarget(combatTime, speed) {
      let now = Date.now();
      
      // Finestra Rientro: Combat +4m -> +7m
      let rStart = combatTime.getTime() + (4 * 60000);
      let rEnd = combatTime.getTime() + (7 * 60000);
      
      let best = null;
      let minWait = Infinity;
      
      for(let c of DB) {
        if(c.x === myCastle.x && c.y === myCastle.y) continue;
        if(!c.p) continue; // Solo habitat con Player ID
        
        let dx = c.x - myCastle.x;
        let dy = c.y - myCastle.y;
        let dist = Math.sqrt(dx*dx + dy*dy); // Cartesiana pura 1:1
        
        if(dist < 0.1) continue;
        
        let travelMs = dist * speed * 1000;
        
        let lStart = rStart - (travelMs * 2);
        let lEnd = rEnd - (travelMs * 2);
        
        if(lEnd < now) continue;
        
        let wait = Math.max(0, lStart - now);
        
        // Cerca attesa 0 (SUBITO) o minima
        if(wait === 0) {
            if(minWait > 0) {
                minWait = 0;
                best = { c: c, dist: dist, lStart: lStart, lEnd: lEnd, travelMs: travelMs, rStart: rStart, rEnd: rEnd };
            } else {
                if(lEnd > best.lEnd) {
                    best = { c: c, dist: dist, lStart: lStart, lEnd: lEnd, travelMs: travelMs, rStart: rStart, rEnd: rEnd };
                }
            }
        } else {
            if(minWait > 0 && wait < minWait) {
                minWait = wait;
                best = { c: c, dist: dist, lStart: lStart, lEnd: lEnd, travelMs: travelMs, rStart: rStart, rEnd: rEnd };
            }
        }
      }
      return best;
    }

    // --- RENDER ---
    function renderList() {
      let el = document.getElementById('resList');
      el.innerHTML = "";
      
      rows.forEach((r, i) => {
        let div = document.createElement('div');
        div.className = r.covered ? "res-row covered" : (i === selectedRowIndex ? "res-row selected" : "res-row");
        div.id = `row_${i}`;
        
        let tLabel = `${pad(r.t.getHours())}:${pad(r.t.getMinutes())}`;
        let colTime = `<div class="col-time"><div class="t-label">IMP.</div><div class="t-val">${tLabel}</div></div>`;
        
        if(r.type === 'garrison') {
          div.innerHTML = `${colTime}<div class="col-info" style="color:#666">Coperto da Guarnigione</div><div class="col-action"></div>`;
          el.appendChild(div);
          return;
        }
        
        let colInfo = `<div class="col-info" id="info_${i}"></div>`;
        
        let btnCov = `<div class="chk-cover ${r.covered?'active':''}" onclick="toggle(${i})">
                        ${r.covered ? '‚úì OK' : 'COPRI'}
                      </div>`;
                      
        let colAct = `<div class="col-action" id="act_${i}">${btnCov}</div>`;
        
        div.innerHTML = colTime + colInfo + colAct;
        el.appendChild(div);
        
        updateRow(i);
      });

      // MESSAGGIO FINE LISTA
      let endMsg = document.createElement('div');
      endMsg.className = "end-msg";
      endMsg.innerText = "Le tue truppe totali non possono coprire oltre questo turno";
      el.appendChild(endMsg);
    }

    function loop() {
      let now = Date.now();
      let troop = document.getElementById('selBattleTroop').value;
      let bonus = document.getElementById('chkMap').checked;
      let speed = bonus ? T_BONUS[troop] : T_BASE[troop];

      rows.forEach((r, i) => {
        if(r.type !== 'garrison' && !r.covered) {
          if(!r.target || now > r.target.lEnd) {
            r.target = findTarget(r.t, speed);
            updateRow(i); 
          } else {
            updateTimer(i);
          }
        }
      });
    }

    function updateRow(i) {
      let r = rows[i];
      if(r.type === 'garrison') return;

      let actDiv = document.getElementById(`act_${i}`);
      let infoDiv = document.getElementById(`info_${i}`);
      if(!actDiv) return;

      if(!actDiv.querySelector('.chk-cover')) {
         actDiv.innerHTML = `<div class="chk-cover ${r.covered?'active':''}" onclick="toggle(${i})">${r.covered?'OK':'COPRI'}</div>`;
      }

      if(r.covered) {
        infoDiv.innerHTML = `<span style="color:#666; font-style:italic">Turno Coperto</span>`;
        return;
      }

      if(!r.target) {
        infoDiv.innerHTML = `<span class="st-err">Nessun Target Trovato</span>`;
        if(actDiv.querySelector('.lnk-btn')) actDiv.querySelector('.lnk-btn').remove();
        return;
      }

      let linkUrl = `l+k://coordinates?${r.target.c.x},${r.target.c.y}&${worldId}`;
      
      let existingLink = actDiv.querySelector('.lnk-btn');
      if(!existingLink) {
        let a = document.createElement('a');
        a.className = 'lnk-btn hidden';
        a.href = linkUrl;
        a.innerText = "LANCIA";
        a.onclick = function() { selectRow(i); };
        actDiv.prepend(a); 
      } else {
        existingLink.href = linkUrl;
      }
      
      updateTimer(i);
    }

    function updateTimer(i) {
      let r = rows[i];
      if(!r.target || r.covered) return;
      
      let now = Date.now();
      let infoDiv = document.getElementById(`info_${i}`);
      let lnkBtn = document.querySelector(`#act_${i} .lnk-btn`);
      
      let wait = r.target.lStart - now;
      let dist = Math.round(r.target.dist); 
      let coord = `${r.target.c.x},${r.target.c.y}`;
      
      // Calcolo RIMBALZO (Arrivo al target)
      let bounceTimeMs = r.target.rStart - r.target.travelMs;
      
      // Finestra Rimbalzo: Il ritorno deve essere tra rStart e rEnd
      // Quindi il rimbalzo deve avvenire tra (rStart - travel) e (rEnd - travel)
      let bStartMs = r.target.rStart - r.target.travelMs;
      let bEndMs = r.target.rEnd - r.target.travelMs;
      
      let bStartD = new Date(bStartMs);
      let bEndD = new Date(bEndMs);
      
      let bStr = `${pad(bStartD.getHours())}:${pad(bStartD.getMinutes())} - ${pad(bEndD.getHours())}:${pad(bEndD.getMinutes())}`;

      if(wait > 0) {
        let h = Math.floor(wait / 3600000);
        let m = Math.floor((wait % 3600000) / 60000);
        let s = Math.floor((wait % 60000) / 1000);
        let wStr = h>0 ? `${h}h ${m}m ${s}s` : `${m}m ${s}s`;

        infoDiv.innerHTML = `
          <div class="info-status st-wait">‚è≥ Attendi: ${wStr}</div>
          <div class="info-sub">
            <span class="bounce-win">Rimbalzo: ${bStr}</span><br>
            <span>Target:</span> ${dist} campi
          </div>
        `;
        if(lnkBtn) lnkBtn.classList.add('hidden');

      } else if(now <= r.target.lEnd) {
        infoDiv.innerHTML = `
          <div class="info-status st-now">‚ñ∂ LANCIA ORA!</div>
          <div class="info-sub">
            <span class="bounce-win">Rimbalzo: ${bStr}</span><br>
            <span>Target:</span> ${dist} campi (${coord})
          </div>
        `;
        if(lnkBtn) lnkBtn.classList.remove('hidden');

      } else {
        infoDiv.innerHTML = `<span class="st-err">Scaduto (Cerco...)</span>`;
        if(lnkBtn) lnkBtn.classList.add('hidden');
      }
    }

    function selectRow(i) {
        selectedRowIndex = i;
        rows.forEach((r, idx) => {
            let el = document.getElementById(`row_${idx}`);
            if(el) {
                if(idx === selectedRowIndex && !r.covered) el.classList.add('selected');
                else el.classList.remove('selected');
            }
        });
    }

    function toggle(i) {
      rows[i].covered = !rows[i].covered;
      if(rows[i].covered && selectedRowIndex === i) {
          selectedRowIndex = -1;
      }
      renderList();
    }

    function reset() {
      document.getElementById('inputArea').classList.remove('hidden');
      document.getElementById('resArea').classList.add('hidden');
      if(ticker) clearInterval(ticker);
    }

    function pad(n) { return n<10?'0'+n:n; }
  </script>
</body>
</html>
