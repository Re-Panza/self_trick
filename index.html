<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Re Panza Brain — Precision Calc</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap');

:root {
  --bg-deep:#050608;
  --bg-card:#0f1216;
  --border:#232830;
  --accent:#d4a843;
  --text-primary:#e6edf3;
  --text-muted:#8b949e;
  --green:#3fb950;
  --red:#f85149;
}
body{ font-family:'Rajdhani',sans-serif; background:var(--bg-deep); color:var(--text-primary); padding:20px; }
.wrap{ max-width:900px; margin:0 auto; }
.card{ background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:20px; margin-bottom:20px; }
.fg{ margin-bottom:15px; }
label{ display:block; font-size:0.75rem; text-transform:uppercase; color:var(--text-muted); margin-bottom:5px; }
input, select{ width:100%; background:#000; border:1px solid var(--border); color:#fff; padding:10px; border-radius:4px; font-family:'Share Tech Mono'; }
.btn{ width:100%; padding:15px; border:none; border-radius:4px; font-weight:700; text-transform:uppercase; cursor:pointer; background:var(--accent); color:#000; }
table{ width:100%; border-collapse:collapse; font-family:'Share Tech Mono'; margin-top:10px; }
th{ text-align:left; color:var(--text-muted); font-size:0.7rem; border-bottom:1px solid var(--border); padding:10px; }
td{ padding:12px 10px; border-bottom:1px solid rgba(255,255,255,0.05); }
.lnk-btn{ text-decoration:none; background:var(--accent); color:#000; padding:5px 10px; border-radius:4px; font-weight:bold; font-size:0.8rem; }
.wait-box{ color:var(--red); font-weight:bold; }
.hidden{ display:none; }
tr.cov{ opacity:0.4; background:rgba(0,255,0,0.05); }
</style>
</head>
<body>

<div class="wrap">
  <div class="card" id="inputPanel">
    <h2 style="color:var(--accent); margin-bottom:20px;">RE PANZA BRAIN - 327</h2>
    <div class="fg"><label>Link Castello Partenza</label><input type="text" id="inCoord" placeholder="l+k://coordinates?X,Y&327"></div>
    <div style="display:flex; gap:10px;">
      <div class="fg" style="flex:1;"><label>Data Impatto (Ritorno)</label><input type="date" id="inDate"></div>
      <div class="fg" style="flex:1;"><label>Ora Fine Finestra (es 07:17)</label><input type="time" id="inTime" value="07:17"></div>
    </div>
    <div style="display:flex; gap:10px;">
      <div class="fg" style="flex:1;"><label>Truppa</label><select id="selTroop"></select></div>
      <div class="fg" style="flex:1;"><label>Guarnigione</label><input type="number" id="inGar" value="1000"></div>
    </div>
    <button class="btn" onclick="startCalc()">CALCOLA FINESTRE</button>
  </div>

  <div class="card hidden" id="outputPanel">
    <table id="resTable">
      <thead>
        <tr>
          <th>TURNO (Ritorno)</th>
          <th>OK</th>
          <th>AZIONE</th>
          <th>IMPATTO SU TARGET</th>
        </tr>
      </thead>
      <tbody id="tBody"></tbody>
    </table>
    <button class="btn" style="margin-top:20px; background:#222; color:#fff;" onclick="location.reload()">INDIETRO</button>
  </div>
</div>

<script>
const TR = { "Lanciere": 700, "Balestriere": 600, "Cavaliere pesante": 300, "Spadaccino": 800, "Arciere": 500, "Cavaliere leggero": 400, "Carretto a mano": 800, "Carro bue": 1000, "Ashigaru": 480, "Arciere daikyu": 450, "Samurai": 300, "Berserker": 420, "Arciere Nordico": 390, "Cavaliere con Ascia": 360, "Torre d'assedio": 480, "Ballista": 450, "Catapulta": 420 };

let W = [];
let S = { myCast: null, rows: [], speed: 0 };

// Caricamento DB
fetch('https://raw.githubusercontent.com/Re-Panza/lk_tool/refs/heads/main/mondo327.json')
  .then(r=>r.json()).then(j=> W = parseCastles(j));

function parseCastles(obj, arr=[]){
  if(Array.isArray(obj)) obj.forEach(x => parseCastles(x, arr));
  else if(obj && typeof obj === 'object'){
    if(obj.x !== undefined && obj.y !== undefined) arr.push({x:obj.x, y:obj.y, p:(obj.p||obj.pt||50)});
    else for(let k in obj) parseCastles(obj[k], arr);
  }
  return arr;
}

window.onload = () => {
  document.getElementById('inDate').value = new Date().toISOString().split('T')[0];
  let h = ""; for(let k in TR) h+=`<option value="${k}">${k}</option>`;
  document.getElementById('selTroop').innerHTML = h;
};

function startCalc(){
  let coord = document.getElementById('inCoord').value.match(/coordinates\?(\d+),(\d+)/);
  if(!coord) return alert("Inserisci link coordinate!");
  
  let myX = +coord[1], myY = +coord[2];
  S.myCast = W.find(c => c.x === myX && c.y === myY) || {x:myX, y:myY, p:50};
  S.speed = TR[document.getElementById('selTroop').value];
  
  let baseTime = new Date(document.getElementById('inDate').value + "T" + document.getElementById('inTime').value);
  let truppe = (+document.getElementById('inGar').value) - 110;
  
  S.rows = [];
  // Turno 0 è la guarnigione, partiamo dal turno 1
  for(let t=1; t <= Math.floor(truppe/51); t++){
    let rEnd = new Date(baseTime.getTime() + (t-1) * 600000); // Finestra rincasata ogni 10 min
    S.rows.push({ turno: t, time: rEnd, covered: false, data: null });
  }

  render();
  document.getElementById('inputPanel').classList.add('hidden');
  document.getElementById('outputPanel').classList.remove('hidden');
  setInterval(liveUpdate, 1000);
}

function findIdealTarget(targetReturnTime){
  let now = Date.now();
  let maxFields = S.myCast.p;
  let best = null;
  let minWait = Infinity;

  for(let c of W){
    if(c.x === S.myCast.x && c.y === S.myCast.y) continue;
    let d = Math.sqrt((c.x-S.myCast.x)**2 + (c.y-S.myCast.y)**2);
    if(d > maxFields) continue;

    // Tempo totale viaggio (Andata + Ritorno)
    let travelMs = (d * S.speed * 2) * 1000;
    
    // Per tornare al "targetReturnTime", devo partire alle:
    let launchTime = targetReturnTime.getTime() - travelMs;
    
    // Se il lancio è nel passato, questo castello non va bene (tornerebbe troppo tardi)
    if(launchTime < now) continue;

    // Vogliamo il castello che ci permette di lanciare il più presto possibile (o subito)
    let wait = launchTime - now;
    if(wait < minWait){
      minWait = wait;
      best = { x:c.x, y:c.y, wait: wait, launch: launchTime, travel: travelMs, lnk: `l+k://coordinates?${c.x},${c.y}&327` };
    }
  }
  return best;
}

function render(){
  let tb = document.getElementById('tBody');
  tb.innerHTML = "";
  S.rows.forEach((r, i) => {
    let tr = document.createElement('tr');
    tr.id = `row-${i}`;
    tr.innerHTML = `
      <td>Turno ${r.turno}<br><small style="color:var(--text-muted)">Ritorno: ${fmtT(r.time)}</small></td>
      <td><input type="checkbox" onchange="toggleCov(${i})"></td>
      <td id="act-${i}"></td>
      <td id="imp-${i}"></td>
    `;
    tb.appendChild(tr);
  });
}

function liveUpdate(){
  let now = Date.now();
  S.rows.forEach((r, i) => {
    if(r.covered) return;
    
    let data = findIdealTarget(r.time);
    let elAct = document.getElementById(`act-${i}`);
    let elImp = document.getElementById(`imp-${i}`);

    if(!data){
      elAct.innerHTML = "<span style='color:var(--red)'>FUORI PORTATA</span>";
      elImp.innerHTML = "--";
    } else {
      // Calcolo orario impatto (metà del viaggio)
      let impactTime = new Date(data.launch + (data.travel / 2));
      elImp.innerHTML = `<b>${fmtT(impactTime)}</b><br><small style="color:var(--text-muted)">su ${data.x},${data.y}</small>`;

      if(data.wait <= 0){
        elAct.innerHTML = `<a href="${data.lnk}" class="lnk-btn" target="_blank">INVIA ORA</a>`;
      } else {
        let sec = Math.ceil(data.wait / 1000);
        let m = Math.floor(sec/60), s = sec%60;
        elAct.innerHTML = `<span class="wait-box">ASPETTA ${m}:${s.toString().padStart(2,'0')}</span>`;
      }
    }
  });
}

function toggleCov(i){
  S.rows[i].covered = !S.rows[i].covered;
  document.getElementById(`row-${i}`).classList.toggle('cov');
  if(S.rows[i].covered){
    document.getElementById(`act-${i}`).innerHTML = "<span style='color:var(--green)'>COPERTO</span>";
    document.getElementById(`imp-${i}`).innerHTML = "✓";
  }
}

function fmtT(d){ return d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0')+":"+d.getSeconds().toString().padStart(2,'0'); }
</script>
</body>
</html>
