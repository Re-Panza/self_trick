<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Re Panza Brain — Precision Multi-Troop</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap');
:root { --bg:#050608; --card:#0f1216; --border:#232830; --accent:#d4a843; --text:#e6edf3; --muted:#8b949e; --green:#3fb950; --red:#f85149; }
body{ font-family:'Rajdhani',sans-serif; background:var(--bg); color:var(--text); padding:10px; margin:0; }
.wrap{ max-width:1000px; margin:0 auto; }
.card{ background:var(--card); border:1px solid var(--border); border-radius:8px; padding:15px; margin-bottom:10px; border:1px solid var(--border); }
label{ display:block; font-size:0.7rem; text-transform:uppercase; color:var(--muted); margin-bottom:4px; }
input, select{ width:100%; background:#000; border:1px solid var(--border); color:#fff; padding:8px; border-radius:4px; font-family:'Share Tech Mono'; margin-bottom:10px; box-sizing:border-box; }
.btn{ width:100%; padding:15px; border:none; border-radius:4px; font-weight:700; text-transform:uppercase; cursor:pointer; background:var(--accent); color:#000; font-size:1rem; }
table{ width:100%; border-collapse:collapse; font-family:'Share Tech Mono'; font-size:0.8rem; }
th{ text-align:left; color:var(--muted); font-size:0.65rem; border-bottom:1px solid var(--border); padding:8px; }
td{ padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.05); }
.lnk-btn{ text-decoration:none; background:var(--green); color:#fff; padding:5px 10px; border-radius:4px; font-weight:bold; display:inline-block; font-size:0.75rem; }
.wait-box{ color:var(--red); font-weight:bold; font-size:0.8rem; }
.hidden{ display:none; }
tr.cov{ opacity:0.25; background:rgba(0,255,0,0.05); pointer-events: none; }
.sticky-header { position: sticky; top: 0; background: var(--bg); z-index: 100; padding: 10px 0; }
</style>
</head>
<body>

<div class="wrap">
  <div id="setup">
    <div class="card">
      <h2 style="color:var(--accent); margin:0 0 10px 0; font-size:1.2rem;">RE PANZA BRAIN - CONFIG</h2>
      <label>Link Coordinate Partenza</label>
      <input type="text" id="inCoord" placeholder="l+k://coordinates?X,Y&Mondo" oninput="loadDB(this.value)">
      <div id="dbStatus" style="font-size:0.7rem; margin-bottom:10px;"></div>
      
      <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>Data Rientro</label><input type="date" id="inDate"></div>
        <div style="flex:1"><label>Ora Fine (es. 07:17)</label><input type="time" id="inTime" value="07:17"></div>
      </div>
      
      <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>Guarnigione</label><input type="number" id="inGar" value="1000"></div>
        <div style="flex:1; padding-top:20px;">
          <label style="display:flex; align-items:center; gap:5px;">
            <input type="checkbox" id="chkMap" style="width:auto; margin:0;"> Mappa (0.95x)
          </label>
        </div>
      </div>
      <button class="btn" onclick="initCalculations()">GENERA TURNI</button>
    </div>
  </div>

  <div id="results" class="hidden">
    <div class="card sticky-header">
      <div style="display:flex; gap:10px; align-items:center;">
        <div style="flex:2">
          <label>Cambia Truppa (Aggiorna link e tempi)</label>
          <select id="switchTroop" onchange="updateTroop()"></select>
        </div>
        <div style="flex:1">
          <button class="btn" style="padding:8px; font-size:0.7rem; background:#222; color:#fff;" onclick="location.reload()">RESET</button>
        </div>
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>FINE FINESTRA</th>
            <th>OK</th>
            <th>AZIONE / ATTESA</th>
            <th>IMPATTO (ANDATA)</th>
            <th>TARGET</th>
          </tr>
        </thead>
        <tbody id="tBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const TRUPPE = { "Lanciere": 700, "Balestriere": 600, "Cavaliere pesante": 300, "Spadaccino": 800, "Arciere": 500, "Cavaliere leggero": 400, "Carretto a mano": 800, "Carro bue": 1000, "Ashigaru": 480, "Arciere daikyu": 450, "Samurai": 300, "Berserker": 420, "Arciere Nordico": 390, "Cavaliere con Ascia": 360, "Torre d'assedio": 480, "Ballista": 450, "Catapulta": 420 };
let WORLD_DB = [], STATE = { myCast: null, rows: [], currentSpeed: 0, worldId: null };

window.onload = () => {
  document.getElementById('inDate').value = new Date().toISOString().split('T')[0];
  let h = ""; for(let k in TRUPPE) h+=`<option value="${k}">${k}</option>`;
  document.getElementById('switchTroop').innerHTML = h;
};

async function loadDB(val) {
  let m = val.match(/&(\d+)/);
  if (!m) return;
  let wid = m[1];
  if (STATE.worldId === wid) return;
  STATE.worldId = wid;
  let status = document.getElementById('dbStatus');
  status.innerText = "Caricamento database...";
  
  const baseUrl = "https://re-panza.github.io/lk_tool/";
  for (let path of [`mondo_${wid}.json`, `data_${wid}.json`]){
    try {
      let r = await fetch(baseUrl + path);
      if(r.ok){
        let j = await r.json();
        WORLD_DB = parse(j).filter(c => c.p && c.p !== ""); // FILTRO CASTELLI SENZA PUNTI
        status.innerHTML = `<span style="color:var(--green)">✓ Mondo ${wid}: ${WORLD_DB.length} Target validi</span>`;
        return;
      }
    } catch(e){}
  }
  status.innerHTML = `<span style="color:var(--red)">✗ Database non trovato</span>`;
}

function parse(obj, arr=[]){
  if(Array.isArray(obj)) obj.forEach(x => parse(x, arr));
  else if(obj && typeof obj === 'object'){
    if(obj.x !== undefined && obj.y !== undefined) arr.push({x:obj.x, y:obj.y, p:obj.p || obj.pt});
    else for(let k in obj) parse(obj[k], arr);
  }
  return arr;
}

function initCalculations(){
  let coord = document.getElementById('inCoord').value.match(/coordinates\?(\d+),(\d+)/);
  if(!coord || WORLD_DB.length === 0) return alert("Inserisci coordinate e attendi caricamento DB");
  
  let myX = +coord[1], myY = +coord[2];
  STATE.myCast = WORLD_DB.find(c => c.x === myX && c.y === myY) || {x:myX, y:myY, p:50};
  
  updateTroop(); // Imposta la velocità iniziale
  
  let baseEndTime = new Date(document.getElementById('inDate').value + "T" + document.getElementById('inTime').value);
  let totalTurns = Math.floor((+document.getElementById('inGar').value - 110) / 51);
  
  STATE.rows = [];
  for(let t=1; t <= totalTurns; t++){
    let rEnd = new Date(baseEndTime.getTime() + (t-1) * 600000);
    let rStart = new Date(rEnd.getTime() - 180000);
    STATE.rows.push({ t, rStart, rEnd, covered: false });
  }

  render();
  document.getElementById('setup').classList.add('hidden');
  document.getElementById('results').classList.remove('hidden');
  setInterval(tick, 1000);
}

function updateTroop(){
  let base = TRUPPE[document.getElementById('switchTroop').value];
  STATE.currentSpeed = document.getElementById('chkMap').checked ? (base * 0.95) : base;
}

function tick(){
  let now = Date.now();
  STATE.rows.forEach((r, i) => {
    if(r.covered) return;
    
    let best = null;
    let minWait = Infinity;

    // CERCA IL CASTELLO PERFETTO PER QUESTA TRUPPA
    for(let c of WORLD_DB){
      if(c.x === STATE.myCast.x && c.y === STATE.myCast.y) continue;
      let d = Math.sqrt((c.x-STATE.myCast.x)**2 + (c.y-STATE.myCast.y)**2);
      if(d > STATE.myCast.p) continue;

      let travelMs = (d * STATE.currentSpeed * 2) * 1000;
      let lStart = r.rStart.getTime() - travelMs;
      let lEnd = r.rEnd.getTime() - travelMs;

      if(now > lEnd) continue; // Troppo tardi per questo villaggio

      let wait = lStart - now;
      if(wait < minWait){
        minWait = wait;
        best = { x:c.x, y:c.y, lStart, lEnd, travelMs, lnk:`l+k://coordinates?${c.x},${c.y}&${STATE.worldId}` };
      }
    }

    let elA = document.getElementById(`act-${i}`);
    let elI = document.getElementById(`imp-${i}`);
    let elT = document.getElementById(`tgt-${i}`);

    if(!best){
      elA.innerHTML = "<span style='color:var(--red)'>NO TARGET</span>";
      elI.innerText = "--"; elT.innerText = "--";
    } else {
      elT.innerText = `${best.x},${best.y}`;
      let impactTime = new Date(best.lStart + (best.travelMs/2));
      elI.innerHTML = `<b>${fmtT(impactTime)}</b>`;

      if(now >= best.lStart){
        elA.innerHTML = `<a href="${best.lnk}" class="lnk-btn" target="_blank">INVIA ORA</a>`;
      } else {
        let s = Math.ceil(best.wait/1000);
        elA.innerHTML = `<span class="wait-box">-${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}</span>`;
      }
    }
  });
}

function render(){
  let h = "";
  STATE.rows.forEach((r, i) => {
    h += `<tr id="row-${i}">
      <td><b>${fmtT(r.rEnd)}</b></td>
      <td><input type="checkbox" onchange="toggle(${i})"></td>
      <td id="act-${i}"></td>
      <td id="imp-${i}"></td>
      <td id="tgt-${i}" style="color:var(--accent)"></td>
    </tr>`;
  });
  document.getElementById('tBody').innerHTML = h;
}

function toggle(i){
  STATE.rows[i].covered = !STATE.rows[i].covered;
  document.getElementById(`row-${i}`).classList.toggle('cov');
  if(STATE.rows[i].covered) document.getElementById(`act-${i}`).innerHTML = "<b>OK</b>";
}

function fmtT(d){ return d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0')+":"+d.getSeconds().toString().padStart(2,'0'); }
</script>
</body>
</html>
