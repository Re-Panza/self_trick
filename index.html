<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>LK Brain 337 - Self Trickle</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');

    :root {
      --bg: #000000;
      --card: #111111;
      --text: #e0e0e0;
      --gold: #d4af37;
      --green: #00e676;
      --red: #ff1744;
      --blue: #2979ff;
      --border: #333;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Roboto Condensed', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      padding-bottom: 40px;
    }

    /* CONTROLLI */
    .controls {
      background: var(--card); padding: 10px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
    .col { flex: 1; }
    label { font-size: 10px; color: #888; text-transform: uppercase; display: block; margin-bottom: 2px; }
    
    input, select {
      width: 100%; background: #000; color: #fff; border: 1px solid #444; 
      border-radius: 4px; padding: 8px; font-size: 14px; outline: none; font-weight: bold;
    }
    input:focus { border-color: var(--gold); }

    .btn {
      width: 100%; padding: 10px; background: var(--gold); color: #000;
      font-weight: bold; border: none; border-radius: 4px; text-transform: uppercase; font-size: 14px; margin-top: 5px;
    }

    /* LISTA RISULTATI */
    .res-row {
      display: flex; align-items: center; padding: 10px 8px; border-bottom: 1px solid #222; background: var(--bg);
    }
    .res-row:nth-child(even) { background: #080808; }
    .res-row.covered { opacity: 0.3; filter: grayscale(100%); }

    /* COLONNE */
    .col-time {
      width: 50px; text-align: center; font-size: 11px; color: #888; line-height: 1.2;
      border-right: 1px solid #222; margin-right: 8px; padding-right: 4px;
    }
    .col-time span { font-size: 14px; color: #fff; font-weight: bold; display: block; }

    .col-info { flex: 1; min-width: 0; }
    .info-status { font-size: 13px; font-weight: bold; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
    .info-dist { font-size: 11px; color: #666; font-family: monospace; }

    .col-action { width: 90px; margin-left: 8px; display: flex; flex-direction: column; gap: 4px; }

    /* BOTTONI */
    .lnk-btn {
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 30px; background: rgba(41, 121, 255, 0.1); 
      border: 1px solid var(--blue); color: var(--blue); text-decoration: none; 
      font-size: 11px; font-weight: bold; border-radius: 4px; text-transform: uppercase;
    }
    .lnk-btn:active { background: var(--blue); color: white; }

    .chk-cover {
      width: 100%; height: 24px; display: flex; align-items: center; justify-content: center;
      background: #111; border: 1px solid #333; border-radius: 4px; cursor: pointer; color: #555; font-size: 10px;
    }
    .chk-cover.active { background: #222; color: var(--green); border-color: var(--green); }

    /* STATUS COLORS */
    .st-wait { color: var(--gold); }
    .st-now { color: var(--green); animation: pulse 1s infinite; }
    .st-err { color: var(--red); font-size: 12px; }

    @keyframes pulse { 50% { opacity: 0.5; } }
    .hidden { display: none !important; }
    .status-bar { font-size: 11px; text-align: center; color: #666; margin-bottom: 5px; }
  </style>
</head>

<body>

  <div id="inputArea" class="controls">
    <div class="row">
      <input type="text" id="inCoord" placeholder="Link Partenza (l+k://...)" oninput="checkDB()">
    </div>
    <div id="dbStatus" class="status-bar">In attesa link...</div>

    <div class="row">
      <div class="col"><label>Giorno Impatto</label><input type="date" id="inDate"></div>
      <div class="col"><label>Ora Impatto</label><input type="time" id="inTime" step="60"></div>
    </div>

    <div class="row">
      <div class="col" style="flex:2"><label>Truppa</label><select id="selTroop"></select></div>
      <div class="col"><label>Plotone</label>
        <select id="selBatch">
          <option value="51">51</option><option value="55">55</option>
          <option value="60">60</option><option value="76">76</option>
        </select>
      </div>
    </div>

    <div class="row" style="justify-content:space-between; padding:5px 0;">
      <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#fff; cursor:pointer">
        <input type="checkbox" id="chkMap" style="width:18px; height:18px"> Bonus Mappa (+5%)
      </label>
      <div style="display:flex; align-items:center; gap:5px">
        <label style="margin:0">Guarnigione:</label>
        <input type="number" id="inGarrison" value="1000" style="width:60px; text-align:center">
      </div>
    </div>

    <button class="btn" onclick="startCalc()">CALCOLA</button>
  </div>

  <div id="resArea" class="hidden">
    <div style="background:#1a1a1a; padding:8px; border-bottom:1px solid #333; display:flex; gap:10px; position:sticky; top:0; z-index:100">
      <button onclick="reset()" style="background:#333; color:#fff; border:none; padding:0 12px; font-weight:bold; border-radius:4px; font-size:16px">←</button>
      <select id="selBattleTroop" onchange="changeTroopLive()" style="background:#000; color:#fff; border:1px solid #444"></select>
    </div>
    <div id="resList" class="result-list"></div>
  </div>

  <script>
    const T_BASE = { "Lanciere":700, "Balestriere":600, "Cav. Pesante":300, "Spadaccino":800, "Arciere":500, "Cav. Leggero":400, "Carro":1000, "Torre":480, "Catapulta":420 };
    const T_BONUS = { "Lanciere":665, "Balestriere":570, "Cav. Pesante":285, "Spadaccino":760, "Arciere":475, "Cav. Leggero":380, "Carro":950, "Torre":456, "Catapulta":399 };

    let DB = [], myCastle = null, worldId = null;
    let rows = [], ticker = null;

    window.onload = () => {
      let d = new Date();
      document.getElementById('inDate').value = d.toISOString().split('T')[0];
      document.getElementById('inTime').value = '07:00';
      
      let html = "";
      for(let k in T_BASE) html += `<option value="${k}">${k}</option>`;
      document.getElementById('selTroop').innerHTML = html;
      document.getElementById('selBattleTroop').innerHTML = html;
    };

    function checkDB() {
      let val = document.getElementById('inCoord').value;
      let m = val.match(/coordinates\?(\d+),(\d+)&(\d+)/);
      let st = document.getElementById('dbStatus');
      
      if(m) {
        let w = m[3];
        if(w !== worldId) {
          worldId = w;
          st.innerHTML = `<span style="color:var(--gold)">Scarico Mondo ${w}...</span>`;
          fetch(`https://raw.githubusercontent.com/Re-Panza/lk_database/refs/heads/main/database_mondo_${w}.json`)
            .then(r => r.json())
            .then(d => {
              DB = [];
              const flat = (n) => { 
                if(Array.isArray(n)) n.forEach(flat); 
                else if(n && n.x) {
                  n.p = n.p || n.pid || n.playerid || 0;
                  DB.push(n); 
                }
                else if(typeof n==='object') Object.values(n).forEach(flat); 
              };
              flat(d);
              st.innerHTML = `<span style="color:var(--green)">✓ DB Pronto (${DB.length} castelli)</span>`;
            })
            .catch(() => st.innerHTML = `<span style="color:var(--red)">Errore DB</span>`);
        }
      }
    }

    function startCalc() {
      if(!DB.length) return alert("Attendi il DB!");
      let val = document.getElementById('inCoord').value;
      let m = val.match(/coordinates\?(\d+),(\d+)&(\d+)/);
      if(!m) return alert("Link non valido");
      
      myCastle = { x: parseInt(m[1]), y: parseInt(m[2]) };
      
      let d = document.getElementById('inDate').value;
      let t = document.getElementById('inTime').value;
      let startT = new Date(d + "T" + t);
      
      let garrison = parseInt(document.getElementById('inGarrison').value) || 1000;
      let batch = parseInt(document.getElementById('selBatch').value);
      
      document.getElementById('selBattleTroop').value = document.getElementById('selTroop').value;
      document.getElementById('inputArea').classList.add('hidden');
      document.getElementById('resArea').classList.remove('hidden');
      
      rows = [];
      let left = garrison - 110;
      
      rows.push({ t: new Date(startT), type: 'garrison' });
      
      let step = 1;
      while(left > 0 && step < 120) {
        let combatT = new Date(startT.getTime() + (step * 600000));
        rows.push({ t: combatT, type: 'wave', target: null, covered: false });
        left -= Math.min(batch, left);
        step++;
      }
      
      reCalcAll();
      if(ticker) clearInterval(ticker);
      ticker = setInterval(loop, 1000);
      renderList();
    }

    function reCalcAll() {
      let troop = document.getElementById('selBattleTroop').value;
      let bonus = document.getElementById('chkMap').checked;
      let speed = bonus ? T_BONUS[troop] : T_BASE[troop];
      
      rows.forEach(r => {
        if(r.type === 'wave' && !r.covered) {
          r.target = findTarget(r.t, speed);
        }
      });
    }

    function changeTroopLive() {
      reCalcAll();
      renderList();
    }

    // --- LOGICA DI RICERCA INTELLIGENTE ---
    function findTarget(combatTime, speed) {
      let now = Date.now();
      
      // Finestra di RIENTRO (Combat +4m -> +7m)
      let rStart = combatTime.getTime() + (4 * 60000);
      let rEnd = combatTime.getTime() + (7 * 60000);
      
      let best = null;
      let minWait = Infinity; 
      
      // Cerco il target che mi permette di lanciare SUBITO o il PRIMA POSSIBILE
      for(let c of DB) {
        if(c.x === myCastle.x && c.y === myCastle.y) continue;
        if(!c.p) continue; // Solo attivi
        
        let dx = c.x - myCastle.x;
        let dy = c.y - myCastle.y;
        let dist = Math.sqrt(dx*dx + dy*dy) / 32.0;
        
        if(dist < 0.1) continue;
        
        let travelMs = dist * speed * 1000;
        
        // Finestra LANCIO (Parto ORA -> Arrivo -> Torno in tempo)
        let lStart = rStart - (travelMs * 2);
        let lEnd = rEnd - (travelMs * 2);
        
        // Scaduto
        if(lEnd < now) continue;
        
        let wait = Math.max(0, lStart - now);
        
        // STRATEGIA: Se posso lanciare ORA (wait=0), preferisco il castello più vicino (distanza minore)
        // Se devo aspettare, preferisco quello con meno attesa.
        
        if(wait === 0) {
            // Sono in finestra di lancio. È un candidato "Perfetto".
            // Se ho già un candidato perfetto, prendo quello con distanza minore (meno errori viaggio)
            if(best && best.wait === 0) {
                if(dist < best.dist) {
                    best = { c: c, dist: dist, lStart: lStart, lEnd: lEnd, wait: 0, travelMs: travelMs };
                }
            } else {
                // Primo candidato perfetto
                best = { c: c, dist: dist, lStart: lStart, lEnd: lEnd, wait: 0, travelMs: travelMs };
                minWait = 0;
            }
        } else {
            // Candidato futuro. Lo prendo solo se non ho candidati perfetti e se è il più vicino nel tempo
            if(minWait > 0 && wait < minWait) {
                minWait = wait;
                best = { c: c, dist: dist, lStart: lStart, lEnd: lEnd, wait: wait, travelMs: travelMs };
            }
        }
      }
      return best;
    }

    function renderList() {
      let el = document.getElementById('resList');
      el.innerHTML = "";
      
      rows.forEach((r, i) => {
        let div = document.createElement('div');
        div.className = r.covered ? "res-row covered" : "res-row";
        
        let tLabel = `${pad(r.t.getHours())}:${pad(r.t.getMinutes())}`;
        let colTime = `<div class="col-time">Imp.<br><span>${tLabel}</span></div>`;
        
        if(r.type === 'garrison') {
          div.innerHTML = `${colTime}<div class="col-info" style="color:#666">Guarnigione base</div>`;
          el.appendChild(div);
          return;
        }
        
        let colInfo = `<div class="col-info" id="info_${i}"></div>`;
        
        let btnCov = `<div class="chk-cover ${r.covered?'active':''}" onclick="toggle(${i})">
                        ${r.covered ? '✓ OK' : 'COPRI'}
                      </div>`;
                      
        let colAct = `<div class="col-action" id="act_${i}">${btnCov}</div>`;
        
        div.innerHTML = colTime + colInfo + colAct;
        el.appendChild(div);
        
        updateRow(i);
      });
    }

    function loop() {
      let now = Date.now();
      let troop = document.getElementById('selBattleTroop').value;
      let bonus = document.getElementById('chkMap').checked;
      let speed = bonus ? T_BONUS[troop] : T_BASE[troop];

      rows.forEach((r, i) => {
        if(r.type !== 'garrison' && !r.covered) {
          if(!r.target || now > r.target.lEnd) {
            r.target = findTarget(r.t, speed);
            updateRow(i); 
          }
          updateTimer(i);
        }
      });
    }

    function updateRow(i) {
      let r = rows[i];
      let infoDiv = document.getElementById(`info_${i}`);
      let actDiv = document.getElementById(`act_${i}`);
      if(!infoDiv || !actDiv) return;

      if(r.covered) return;

      if(!r.target) {
        infoDiv.innerHTML = `<div class="st-err">Nessun Target Trovato</div>`;
        if(actDiv.children.length > 1) actDiv.lastChild.remove();
        return;
      }

      let linkUrl = `l+k://coordinates?${r.target.c.x},${r.target.c.y}&${worldId}`;
      let dist = Math.round(r.target.dist); // ARROTONDAMENTO MATH.ROUND
      
      let existingLink = actDiv.querySelector('.lnk-btn');
      if(!existingLink) {
        let a = document.createElement('a');
        a.className = 'lnk-btn hidden';
        a.href = linkUrl;
        a.innerText = "LINK";
        actDiv.appendChild(a);
      } else {
        existingLink.href = linkUrl;
      }
      
      updateTimer(i);
    }

    function updateTimer(i) {
      let r = rows[i];
      if(!r.target || r.covered) return;
      
      let now = Date.now();
      let infoDiv = document.getElementById(`info_${i}`);
      let lnkBtn = document.querySelector(`#act_${i} .lnk-btn`);
      
      let wait = r.target.lStart - now;
      let dist = Math.round(r.target.dist);
      let coord = `${r.target.c.x},${r.target.c.y}`;
      
      // Calcolo Arrivo (Solo Andata)
      // Arrivo = Ora Lancio (Stimata) + Tempo Viaggio
      // Se devo aspettare, Ora Lancio = lStart. Se posso lanciare ora, Ora Lancio = Now.
      let launchTimeMs = wait > 0 ? r.target.lStart : now;
      let arrivalMs = launchTimeMs + r.target.travelMs;
      let arrivalDate = new Date(arrivalMs);
      
      let arrStr = `${pad(arrivalDate.getDate())}/${pad(arrivalDate.getMonth()+1)} ${pad(arrivalDate.getHours())}:${pad(arrivalDate.getMinutes())}:${pad(arrivalDate.getSeconds())}`;

      if(wait > 0) {
        let h = Math.floor(wait / 3600000);
        let m = Math.floor((wait % 3600000) / 60000);
        let s = Math.floor((wait % 60000) / 1000);
        
        let waitStr = h > 0 ? `${h}h ${m}m ${s}s` : `${m}m ${s}s`;

        infoDiv.innerHTML = `
          <div class="info-status st-wait">⏳ Attendi: ${waitStr}</div>
          <div class="info-dist">Arrivo: ${arrStr} (Andata)<br>Target: ${dist} campi</div>
        `;
        if(lnkBtn) lnkBtn.classList.add('hidden');
        
      } else if(now <= r.target.lEnd) {
        infoDiv.innerHTML = `
          <div class="info-status st-now">▶ LANCIA ORA!</div>
          <div class="info-dist">Arrivo: ${arrStr} (Andata)<br>Target: ${dist} campi</div>
        `;
        if(lnkBtn) lnkBtn.classList.remove('hidden');
        
      } else {
        infoDiv.innerHTML = `<div class="st-err">Tempo Scaduto...</div>`;
        if(lnkBtn) lnkBtn.classList.add('hidden');
      }
    }

    function toggle(i) {
      rows[i].covered = !rows[i].covered;
      renderList();
    }

    function reset() {
      document.getElementById('inputArea').classList.remove('hidden');
      document.getElementById('resArea').classList.add('hidden');
      if(ticker) clearInterval(ticker);
    }

    function pad(n) { return n<10?'0'+n:n; }
  </script>
</body>
</html>
