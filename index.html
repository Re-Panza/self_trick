<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>LK Brain 337 - Self Trickle</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');

    :root {
      --bg: #000000;
      --card: #151515;
      --text: #e0e0e0;
      --gold: #ffc107;
      --green: #00e676;
      --red: #ff5252;
      --blue: #448aff;
      --border: #333;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Roboto Condensed', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      padding-bottom: 50px;
    }

    .container { max-width: 100%; margin: 0 auto; }

    /* CONTROLLI INPUT */
    .controls {
      background: var(--card); padding: 12px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
    .col { flex: 1; }
    
    label { font-size: 10px; color: #888; text-transform: uppercase; display: block; margin-bottom: 3px; letter-spacing: 0.5px; }
    
    input, select {
      width: 100%; background: #080808; color: #fff; border: 1px solid #444; 
      border-radius: 4px; padding: 10px; font-size: 15px; outline: none; font-weight: bold;
    }
    input:focus { border-color: var(--gold); }

    .btn {
      width: 100%; padding: 12px; background: var(--gold); color: #000;
      font-weight: bold; border: none; border-radius: 4px; 
      text-transform: uppercase; font-size: 14px; margin-top: 5px; cursor: pointer;
    }

    /* LISTA RISULTATI */
    .res-row {
      display: grid; 
      /* Grid Layout: Ora | Info | Azione */
      grid-template-columns: 50px 1fr 90px; 
      gap: 10px;
      align-items: center; padding: 10px; border-bottom: 1px solid #222; background: var(--bg);
    }
    .res-row:nth-child(even) { background: #0b0b0b; }
    .res-row.covered { opacity: 0.3; filter: grayscale(100%); }

    /* COL 1: TEMPO */
    .col-time { text-align: center; border-right: 1px solid #222; padding-right: 5px; }
    .t-label { font-size: 9px; color: #888; text-transform: uppercase; }
    .t-val { font-size: 16px; color: #fff; font-weight: bold; line-height: 1.2; }

    /* COL 2: INFO */
    .col-info { display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
    .info-status { font-size: 13px; font-weight: bold; margin-bottom: 3px; white-space: nowrap; }
    .info-sub { font-size: 11px; color: #999; line-height: 1.3; }
    .info-sub span { color: #ccc; }

    /* COL 3: AZIONE */
    .col-action { display: flex; flex-direction: column; gap: 6px; }

    /* BOTTONI */
    .lnk-btn {
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 32px; background: rgba(68, 138, 255, 0.1); 
      border: 1px solid var(--blue); color: var(--blue); text-decoration: none; 
      font-size: 12px; font-weight: bold; border-radius: 4px; text-transform: uppercase;
    }
    .lnk-btn:active { background: var(--blue); color: white; }

    .chk-cover {
      width: 100%; height: 24px; display: flex; align-items: center; justify-content: center;
      background: #181818; border: 1px solid #333; border-radius: 4px; cursor: pointer; color: #666; font-size: 10px; text-transform: uppercase;
    }
    .chk-cover.active { background: #222; color: var(--green); border-color: var(--green); }

    /* STATUS COLORI */
    .st-wait { color: var(--gold); }
    .st-now { color: var(--green); animation: pulse 1s infinite; }
    .st-err { color: var(--red); font-size: 11px; }

    @keyframes pulse { 50% { opacity: 0.6; } }
    .hidden { display: none !important; }
    .status-bar { font-size: 11px; text-align: center; color: #666; margin-bottom: 5px; min-height: 15px; }
  </style>
</head>

<body>

  <div id="inputArea" class="controls">
    <div class="row">
      <input type="text" id="inCoord" placeholder="Link Partenza (l+k://...)" oninput="checkDB()">
    </div>
    <div id="dbStatus" class="status-bar">In attesa link...</div>

    <div class="row">
      <div class="col"><label>Data Impatto</label><input type="date" id="inDate"></div>
      <div class="col"><label>Ora Impatto</label><input type="time" id="inTime" step="60"></div>
    </div>

    <div class="row">
      <div class="col" style="flex:2"><label>Truppa</label><select id="selTroop"></select></div>
      <div class="col"><label>Plotone</label>
        <select id="selBatch">
          <option value="51">51</option><option value="55">55</option>
          <option value="60">60</option><option value="76">76</option>
        </select>
      </div>
    </div>

    <div class="row" style="justify-content:space-between; padding:5px 0;">
      <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#fff; cursor:pointer">
        <input type="checkbox" id="chkMap" style="width:18px; height:18px"> Bonus Mappa (+5%)
      </label>
      <div style="display:flex; align-items:center; gap:5px">
        <label style="margin:0">Guarnigione:</label>
        <input type="number" id="inGarrison" value="1000" style="width:60px; text-align:center">
      </div>
    </div>

    <button class="btn" onclick="startCalc()">CALCOLA</button>
  </div>

  <div id="resArea" class="hidden">
    <div style="background:#151515; padding:8px; border-bottom:1px solid #333; display:flex; gap:10px; position:sticky; top:0; z-index:100">
      <button onclick="reset()" style="background:#333; color:#fff; border:none; padding:0 12px; font-weight:bold; border-radius:4px; font-size:16px">←</button>
      <select id="selBattleTroop" onchange="changeTroopLive()" style="background:#000; color:#fff; border:1px solid #444"></select>
    </div>
    
    <div id="resList" style="padding-bottom:20px"></div>
  </div>

  <script>
    // --- COSTANTI ---
    const T_BASE = { "Lanciere":700, "Balestriere":600, "Cav. Pesante":300, "Spadaccino":800, "Arciere":500, "Cav. Leggero":400, "Carro":1000, "Torre":480, "Catapulta":420 };
    const T_BONUS = { "Lanciere":665, "Balestriere":570, "Cav. Pesante":285, "Spadaccino":760, "Arciere":475, "Cav. Leggero":380, "Carro":950, "Torre":456, "Catapulta":399 };

    let DB = [], myCastle = null, worldId = null;
    let rows = [], ticker = null;

    // --- INIT ---
    window.onload = () => {
      let d = new Date();
      document.getElementById('inDate').value = d.toISOString().split('T')[0];
      document.getElementById('inTime').value = '07:00';
      
      let html = "";
      for(let k in T_BASE) html += `<option value="${k}">${k}</option>`;
      document.getElementById('selTroop').innerHTML = html;
      document.getElementById('selBattleTroop').innerHTML = html;
    };

    // --- DB LOAD ---
    function checkDB() {
      let val = document.getElementById('inCoord').value;
      let m = val.match(/coordinates\?(\d+),(\d+)&(\d+)/);
      let st = document.getElementById('dbStatus');
      
      if(m) {
        let w = m[3];
        if(w !== worldId) {
          worldId = w;
          st.innerHTML = `<span style="color:var(--gold)">Scarico Mondo ${w}...</span>`;
          fetch(`https://raw.githubusercontent.com/Re-Panza/lk_database/refs/heads/main/database_mondo_${w}.json`)
            .then(r => r.json())
            .then(d => {
              DB = [];
              // Funzione per appiattire il DB e normalizzare i dati
              const flat = (n) => { 
                if(Array.isArray(n)) n.forEach(flat); 
                else if(n && n.x) {
                  // Normalizza ID Player su 'p'
                  // Il DB potrebbe usare 'p', 'pid', 'owner' o 'playerid'
                  // Se n.p è usato per punti, cerchiamo pid. Se non c'è, n.p è player.
                  // Nel dubbio, se n.p esiste lo usiamo come discriminante
                  
                  let playerId = n.p || n.pid || n.playerid || 0;
                  let points = n.pt || n.pts || n.points || 0;
                  
                  // Aggiungiamo solo se coordinate valide
                  DB.push({
                    x: n.x, 
                    y: n.y, 
                    p: playerId, // ID Giocatore
                    pt: points   // Punti
                  }); 
                }
                else if(typeof n==='object') Object.values(n).forEach(flat); 
              };
              flat(d);
              st.innerHTML = `<span style="color:var(--green)">✓ DB Pronto (${DB.length} castelli)</span>`;
            })
            .catch(() => st.innerHTML = `<span style="color:var(--red)">Errore DB</span>`);
        }
      }
    }

    // --- MAIN CALC ---
    function startCalc() {
      if(!DB.length) return alert("Attendi il DB!");
      let val = document.getElementById('inCoord').value;
      let m = val.match(/coordinates\?(\d+),(\d+)&(\d+)/);
      if(!m) return alert("Link non valido");
      
      myCastle = { x: parseInt(m[1]), y: parseInt(m[2]) };
      
      let d = document.getElementById('inDate').value;
      let t = document.getElementById('inTime').value;
      let startT = new Date(d + "T" + t);
      
      let garrison = parseInt(document.getElementById('inGarrison').value) || 1000;
      let batch = parseInt(document.getElementById('selBatch').value);
      
      document.getElementById('selBattleTroop').value = document.getElementById('selTroop').value;
      document.getElementById('inputArea').classList.add('hidden');
      document.getElementById('resArea').classList.remove('hidden');
      
      rows = [];
      let left = garrison - 110;
      
      rows.push({ t: new Date(startT), type: 'garrison' });
      
      let step = 1;
      while(left > 0 && step < 120) {
        let combatT = new Date(startT.getTime() + (step * 600000)); // +10 min
        rows.push({ t: combatT, type: 'wave', target: null, covered: false });
        left -= Math.min(batch, left);
        step++;
      }
      
      reCalcAll();
      if(ticker) clearInterval(ticker);
      ticker = setInterval(loop, 1000);
      renderList();
    }

    function reCalcAll() {
      let troop = document.getElementById('selBattleTroop').value;
      let bonus = document.getElementById('chkMap').checked;
      let speed = bonus ? T_BONUS[troop] : T_BASE[troop];
      
      rows.forEach(r => {
        if(r.type === 'wave' && !r.covered) {
          r.target = findTarget(r.t, speed);
        }
      });
    }

    function changeTroopLive() {
      reCalcAll();
      renderList();
    }

    // --- ALGORITMO DI RICERCA OTTIMIZZATO ---
    function findTarget(combatTime, speed) {
      let now = Date.now();
      
      // Finestra Rientro: Combat +4m -> +7m
      let rStart = combatTime.getTime() + (4 * 60000);
      let rEnd = combatTime.getTime() + (7 * 60000);
      
      let best = null;
      let minWait = Infinity;
      
      // Cerco il target che mi permette di lanciare SUBITO o il PRIMA POSSIBILE
      for(let c of DB) {
        if(c.x === myCastle.x && c.y === myCastle.y) continue;
        
        // FILTRO ID PLAYER: Se c.p (Player ID) è 0 o null, salta
        if(!c.p) continue; 
        
        // 1. Distanza (32 unità raw = 1 campo)
        let dx = c.x - myCastle.x;
        let dy = c.y - myCastle.y;
        let dist = Math.sqrt(dx*dx + dy*dy) / 32.0;
        
        if(dist < 0.1) continue;
        
        // FILTRO PUNTI (Se richiesto): Distanza non deve superare i punti del target
        // c.pt sono i punti
        if(c.pt && dist > c.pt) continue;

        // 2. Tempo Viaggio (Andata)
        let travelMs = dist * speed * 1000;
        
        // 3. Finestra Lancio (Andata)
        // Parto a L, arrivo al target, rimbalzo, torno a R
        // L = R - 2*Travel
        let lStart = rStart - (travelMs * 2);
        let lEnd = rEnd - (travelMs * 2);
        
        // Se finestra scaduta, salta
        if(lEnd < now) continue;
        
        // 4. Attesa
        let wait = Math.max(0, lStart - now);
        
        // PRIORITY LOGIC:
        // Voglio l'attesa PIÙ BASSA (0 è il top).
        
        if(wait === 0) {
            // Trovato candidato perfetto (LANCIO SUBITO)
            // Se ne avevo già uno perfetto, prendo quello con distanza MINORE (più veloce/sicuro)
            if(minWait === 0) {
                if(best && dist < best.dist) {
                    best = { c: c, dist: dist, lStart: lStart, lEnd: lEnd, travelMs: travelMs };
                }
            } else {
                // Primo candidato perfetto trovato
                minWait = 0;
                best = { c: c, dist: dist, lStart: lStart, lEnd: lEnd, travelMs: travelMs };
            }
        } else {
            // Candidato futuro (devo aspettare).
            // Lo considero SOLO se non ho ancora trovato un candidato perfetto (minWait > 0)
            if(minWait > 0 && wait < minWait) {
                minWait = wait;
                best = { c: c, dist: dist, lStart: lStart, lEnd: lEnd, travelMs: travelMs };
            }
        }
      }
      return best;
    }

    // --- RENDER ---
    function renderList() {
      let el = document.getElementById('resList');
      el.innerHTML = "";
      
      rows.forEach((r, i) => {
        let div = document.createElement('div');
        div.className = r.covered ? "res-row covered" : "res-row";
        
        let tLabel = `${pad(r.t.getHours())}:${pad(r.t.getMinutes())}`;
        let colTime = `<div class="col-time"><div class="t-label">IMP.</div><div class="t-val">${tLabel}</div></div>`;
        
        if(r.type === 'garrison') {
          div.innerHTML = `${colTime}<div class="col-info" style="color:#666">Guarnigione base</div><div class="col-action"></div>`;
          el.appendChild(div);
          return;
        }
        
        // Info + Action Placeholder
        let colInfo = `<div class="col-info" id="info_${i}"></div>`;
        let colAct = `<div class="col-action" id="act_${i}"></div>`;
        
        div.innerHTML = colTime + colInfo + colAct;
        el.appendChild(div);
        
        // Primo update
        updateRow(i);
      });
    }

    function loop() {
      let now = Date.now();
      let troop = document.getElementById('selBattleTroop').value;
      let bonus = document.getElementById('chkMap').checked;
      let speed = bonus ? T_BONUS[troop] : T_BASE[troop];

      rows.forEach((r, i) => {
        if(r.type !== 'garrison' && !r.covered) {
          // Se non ho target o target scaduto, cerco nuovo
          if(!r.target || now > r.target.lEnd) {
            r.target = findTarget(r.t, speed);
            updateRow(i); 
          } else {
            updateTimer(i); // Aggiorna solo testo
          }
        }
      });
    }

    function updateRow(i) {
      let r = rows[i];
      if(r.type === 'garrison') return;

      let actDiv = document.getElementById(`act_${i}`);
      let infoDiv = document.getElementById(`info_${i}`);
      if(!actDiv) return;

      // Reset bottoni se necessario
      if(!actDiv.querySelector('.chk-cover')) {
         actDiv.innerHTML = `<div class="chk-cover ${r.covered?'active':''}" onclick="toggle(${i})">${r.covered?'OK':'COPRI'}</div>`;
      }

      if(r.covered) {
        infoDiv.innerHTML = `<span style="color:#666; font-style:italic">Turno Coperto</span>`;
        return;
      }

      if(!r.target) {
        infoDiv.innerHTML = `<span class="st-err">Nessun Target Trovato</span>`;
        if(actDiv.querySelector('.lnk-btn')) actDiv.querySelector('.lnk-btn').remove();
        return;
      }

      let linkUrl = `l+k://coordinates?${r.target.c.x},${r.target.c.y}&${worldId}`;
      
      let existingLink = actDiv.querySelector('.lnk-btn');
      if(!existingLink) {
        let a = document.createElement('a');
        a.className = 'lnk-btn hidden';
        a.href = linkUrl;
        a.innerText = "LANCIA";
        actDiv.prepend(a); // Mette sopra il COPRI
      } else {
        existingLink.href = linkUrl;
      }
      
      updateTimer(i);
    }

    function updateTimer(i) {
      let r = rows[i];
      if(!r.target || r.covered) return;
      
      let now = Date.now();
      let infoDiv = document.getElementById(`info_${i}`);
      let lnkBtn = document.querySelector(`#act_${i} .lnk-btn`);
      
      let wait = r.target.lStart - now;
      let dist = Math.round(r.target.dist); // ARROTONDAMENTO MATH.ROUND
      let coord = `${r.target.c.x},${r.target.c.y}`;
      
      // Calcolo Arrivo (Solo Andata)
      // Se lancio ORA (o appena scatta timer), arrivo tra travelMs
      let launchT = wait > 0 ? r.target.lStart : now;
      let arrT = new Date(launchT + r.target.travelMs);
      
      let arrStr = `${pad(arrT.getDate())}/${pad(arrT.getMonth()+1)} ${pad(arrT.getHours())}:${pad(arrT.getMinutes())}:${pad(arrT.getSeconds())}`;

      if(wait > 0) {
        // ATTESA
        let h = Math.floor(wait / 3600000);
        let m = Math.floor((wait % 3600000) / 60000);
        let s = Math.floor((wait % 60000) / 1000);
        let wStr = h>0 ? `${h}h ${m}m ${s}s` : `${m}m ${s}s`;

        infoDiv.innerHTML = `
          <div class="info-status st-wait">⏳ Attendi: ${wStr}</div>
          <div class="info-sub">
            <span>Arr:</span> ${arrStr}<br>
            <span>Dist:</span> ${dist} campi (${coord})
          </div>
        `;
        if(lnkBtn) lnkBtn.classList.add('hidden');

      } else if(now <= r.target.lEnd) {
        // LANCIO
        infoDiv.innerHTML = `
          <div class="info-status st-now">▶ LANCIA ORA!</div>
          <div class="info-sub">
            <span style="color:#fff">Arr:</span> ${arrStr}<br>
            <span>Dist:</span> ${dist} campi (${coord})
          </div>
        `;
        if(lnkBtn) lnkBtn.classList.remove('hidden');

      } else {
        // SCADUTO
        infoDiv.innerHTML = `<span class="st-err">Scaduto (Cerco...)</span>`;
        if(lnkBtn) lnkBtn.classList.add('hidden');
      }
    }

    function toggle(i) {
      rows[i].covered = !rows[i].covered;
      renderList();
    }

    function reset() {
      document.getElementById('inputArea').classList.remove('hidden');
      document.getElementById('resArea').classList.add('hidden');
      if(ticker) clearInterval(ticker);
    }

    function pad(n) { return n<10?'0'+n:n; }
  </script>
</body>
</html>
